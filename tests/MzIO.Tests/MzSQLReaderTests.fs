module MzSQLReaderTests

open Expecto
open System
open System.IO
open MzIO.MzSQL
open MzIO.Processing
open MzIO.Binary
open MzIO.Commons.Arrays

let getRelativePath (reference: string) (path: string) =
    Path.Combine(reference, path)

let relToDirectory = getRelativePath Environment.CurrentDirectory

let unzipIMzliteArray (a:IMzIOArray<Peak1D>) = 
    let mzData = Array.zeroCreate a.Length
    let intensityData = Array.zeroCreate a.Length
    for i = 0 to a.Length-1 do 
        let peak = a.[i]
        mzData.[i] <- peak.Mz
        intensityData.[i] <- peak.Intensity
    mzData,intensityData

let mzmlPath = relToDirectory "../../../data/MzSQLReader/test.mzlite"

let mzsqlReader = new MzSQL(mzmlPath)
mzsqlReader.Open()

[<Tests>]
let mzmlReaderTests =
    testList "MzSQL Reader" [
        testList "MzSQL Reader IMzIODataReader Functions" [
            testCase "ReadMassSpectra" <| fun () ->
                let ms = 
                    mzsqlReader.ReadMassSpectra("sample=0")
                    |> Seq.head
                Expect.isTrue(
                    MassSpectrum.getID ms = "sample=1 period=1 cycle=2021 experiment=1" &&
                    MassSpectrum.getMsLevel ms = 1 &&
                    Math.Round(MassSpectrum.getScanTime ms,7) =  Math.Round(32.55256667,7) &&
                    MassSpectrum.getPrecursorMZ ms = -1.
                ) "Error in ReadMassSpectra"
            testCase "ReadMassSpectrum" <| fun () ->
                let ms = mzsqlReader.ReadMassSpectrum("sample=1 period=1 cycle=2021 experiment=1")
                Expect.isTrue(
                    MassSpectrum.getID ms = "sample=1 period=1 cycle=2021 experiment=1" &&
                    MassSpectrum.getMsLevel ms = 1 &&
                    Math.Round(MassSpectrum.getScanTime ms,7) =  Math.Round(32.55256667,7) &&
                    MassSpectrum.getPrecursorMZ ms = -1.
                ) "Error in ReadMassSpectrum"
            testCase "ReadSpectrumPeaks" <| fun () ->
                let peak1D = mzsqlReader.ReadSpectrumPeaks("sample=1 period=1 cycle=2043 experiment=5")
                let referenceMz,referenceIntensity =
                    ([|110.067921679177; 112.089293741558; 115.088928762713; 116.084816518396; 120.080272263631; 126.055879704872; 129.054229201944; 129.10168467014; 130.084682050174; 131.084392120746; 133.086421358308;
                    134.993704274376; 136.075392751591; 136.589505586897; 140.079079320189; 142.106456602034; 143.082927014078; 143.117416314022; 145.11624543868; 147.112984666352; 148.116975562147; 157.133416606408;
                    158.097018064344; 158.138097686125; 159.099098351036; 160.095674254157; 170.059102581778; 170.102787901308; 171.110844191952; 173.11371531979; 175.119920932297; 183.1091191437; 183.145948716926;
                    185.127886709169; 185.151417721143; 185.163529703216; 186.129754880222; 187.142602834682; 188.146287442834; 191.079153807856; 193.133088435765; 198.083850570859; 199.186410433186; 201.12225736963;
                    201.1277349028; 211.107177098009; 212.13794572509; 215.139214212785; 217.132789433918; 219.07610708142; 219.155317282165; 225.098955063077; 228.129762563847; 228.149915739849; 229.118601277362;
                    230.115396438549; 234.122146835898; 240.085569821327; 241.086163861603; 242.669125197389; 243.131835264482; 244.131962349464; 244.171245123563; 245.125754557126; 248.155305160987; 249.121996286459;
                    249.158694794574; 251.153378989441; 254.166096080016; 254.569298210176; 255.073109377026; 255.144549703976; 255.195149473762; 256.072914642031; 258.136897792696; 263.145674602543; 263.595838030256;
                    264.096597627809; 272.169649835409; 273.171908747013; 277.156865612922; 284.140093439302; 284.18744493688; 285.129374362728; 286.148883753911; 286.175018466104; 289.126376941629; 296.193610166722;
                    298.184062527462; 298.681451826418; 300.160290014408; 305.155789240527; 307.184794327283; 307.699178242468; 311.047743994312; 314.170671790342; 315.172318094231; 316.207168750618; 317.196117667479;
                    318.111038508372; 319.171055817113; 321.683128687983; 323.094070292208; 324.188294377653; 325.193687816991; 327.16976106979; 327.667443243561; 328.169812572181; 328.67337322349; 333.158792404148;
                    340.125909986292; 342.195916645758; 346.20401251053; 347.182067847294; 350.145536008002; 350.814590047283; 352.157608963936; 354.640800882367; 354.725443599662; 355.142191676941; 359.247256508404;
                    361.17583061007; 363.687882962626; 363.726532342684; 364.233273913713; 365.494056985568; 365.843202577592; 366.167750422598; 366.18701739759; 367.240106084618; 368.18138775871; 368.222198121184;
                    368.64575322928; 368.717956901498; 369.14586149746; 369.215625359337; 369.643047882423; 370.144571990052; 373.173065724154; 373.187988227465; 374.500977472286; 374.836722905716; 375.167177960387;
                    376.197553544258; 378.830928456889; 379.211000364222; 381.100509131321; 381.180026097836; 381.204705459363; 381.228014483148; 382.200772439774; 384.162394362515; 384.174782133043; 384.502263686435;
                    384.834973434836; 385.173341157391; 385.251258634983; 386.254014976947; 386.269814079502; 387.21718411727; 388.17541104041; 390.211933562615; 390.235998877144; 390.660683589007; 390.723978904678;
                    393.183406570404; 393.215620680554; 393.226998260946; 393.861833615656; 398.209687039675; 398.223500415816; 398.854366576249; 399.04232097938; 399.125091060056; 399.18374757049; 399.209272830717;
                    399.227794015592; 399.239580441433; 399.259786148667; 399.517313445932; 399.70331799237; 399.728589882437; 399.748246347195; 399.829685402141; 399.901302467843; 401.215418580909; 409.206181101855;
                    410.21853135298; 411.200518429909; 411.94989425236; 413.233979879829; 414.236416709592; 416.227465076329; 417.22241375077; 418.220744584175; 426.206015809432; 432.141601073919; 434.206802996036;
                    437.2044371395; 438.178499757531; 441.163238653417; 442.241294599686; 446.232322753681; 446.279979512443; 448.262674482628; 448.282895331495; 449.271840111892; 451.263603692494; 455.273423556172;
                    455.729048744963; 456.223899819471; 467.719072321345; 470.133932016021; 478.280075387574; 479.286543722798; 480.286234978099; 482.232102585743; 484.320397045529; 485.242372494166; 485.324400121065;
                    487.212053491526; 490.20204156459; 491.194199982805; 491.211631602677; 491.700736360912; 491.721308061701; 492.199780658416; 494.215835332528; 495.185365589475; 497.264360273424; 497.704494793922;
                    498.204385252896; 498.295904307562; 498.328221346943; 499.327310078167; 504.243142059628; 504.262065264719; 505.270633427755; 506.306281191922; 507.199454816631; 508.219153059548; 508.273885379268;
                    509.232178155033; 513.2323929579; 517.223236652733; 519.165516532193; 520.749203729412; 522.260281133186; 524.271069034759; 526.265187757665; 526.324258901195; 539.200994570641; 542.303054392752;
                    542.789516165951; 545.29396800133; 546.289812572522; 547.278351449905; 551.252984387919; 552.263421326979; 553.180450873079; 557.251567873664; 557.273719276061; 558.277114407228; 559.298536279716;
                    570.277030292231; 584.187116538217; 584.261801286124; 587.302458137151; 595.297527578216; 595.348938500625; 596.320175317086; 596.35597544268; 599.329085176045; 604.331989070816; 607.308408080784;
                    611.336422165999; 611.456100466208; 612.219325001243; 613.144062410778; 613.216711286932; 613.236068647055; 613.361377448829; 613.427813809388; 614.199439199325; 614.362361813433; 615.377080146944;
                    623.341193542234; 624.254989192625; 625.292369934087; 635.345240610786; 637.351419132767; 651.300674896171; 653.237660697885; 653.324713216769; 654.33177239246; 654.357092464568; 655.328092046078;
                    656.314034912354; 656.344619253952; 685.360899002776; 685.383328140359; 693.355916037854; 697.283467423857; 708.433450574771; 710.238306606715; 726.445805629084; 727.428473895031; 727.44535782533;
                    733.33786350962; 733.434853285553; 736.269401503972; 736.433283172258; 751.459428922444; 865.533777439529|],
                     [|26.523078918457; 3.56872177124023; 74.1309814453125; 18.1587905883789; 22.162410736084; 11.3535957336426; 70.8421325683594; 3.82998061180115; 24.9897003173828; 15.4371299743652; 3.88863778114319;
                     11.7491769790649; 201.026748657227; 11.8184499740601; 7.9789776802063; 24.1096611022949; 65.5205612182617; 48.390064239502; 4.06058502197266; 57.2377624511719; 24.613941192627; 2513.30541992188;
                     12.7148895263672; 113.388832092285; 38.2649307250977; 19.1926498413086; 28.5721569061279; 4.39628982543945; 8.81859493255615; 8.87005615234375; 127.686782836914; 63.8582000732422; 47.8986396789551;
                     1822.30639648438; 13.1866292953491; 4.49123764038086; 108.070854187012; 53.0290794372559; 4.62358045578003; 34.946174621582; 30.448938369751; 14.2323427200317; 14.271897315979; 50.1937255859375;
                     9.56087589263916; 29.38551902771; 4.9095287322998; 160.477752685547; 24.8350105285645; 34.923942565918; 24.9504089355469; 40.4587478637695; 10.1824331283569; 5.09144163131714; 102.044914245605;
                     10.2266511917114; 25.7882499694824; 20.8916931152344; 34.0200576782227; 10.5018997192383; 228.962219238281; 36.8675842285156; 15.8015298843384; 10.5549230575562; 63.7203979492188; 21.2812252044678;
                     189.107238769531; 5.34195375442505; 10.7477960586548; 21.5126361846924; 21.5338439941406; 204.713134765625; 67.3092880249023; 10.7880373001099; 5.4157133102417; 16.4040088653564; 10.9453554153442;
                     16.4336204528809; 1203.13952636719; 100.281600952148; 92.5932693481445; 17.0458297729492; 17.047248840332; 51.2269630432129; 28.5099620819092; 28.5112648010254; 17.1947441101074; 116.02449798584;
                     55.2959251403809; 11.6510410308838; 17.5197734832764; 23.5532817840576; 76.8025207519531; 5.91280794143677; 23.779577255249; 531.867919921875; 107.714752197266; 26.9728946685791; 24.01344871521;
                     42.084098815918; 9.03304004669189; 6.04567432403564; 24.2356739044189; 175.626480102539; 27.3534908294678; 54.873119354248; 153.049438476563; 413.958160400391; 61.1098670959473; 36.9155120849609;
                     55.9493293762207; 102.88542175293; 25.0874576568604; 25.1228694915771; 12.6149320602417; 72.6055755615234; 18.9766883850098; 57.1298942565918; 44.4396667480469; 31.7616729736328; 12.7778367996216;
                     6.40604448318481; 12.8565673828125; 248.841842651367; 154.392730712891; 6.44422626495361; 19.3419094085693; 16.125394821167; 19.3509635925293; 71.0557403564453; 6.46787357330322; 67.9164733886719;
                     168.00048828125; 42.0717391967773; 74.4778747558594; 12.9539031982422; 29.1630592346191; 12.9701890945435; 19.5347118377686; 6.51171255111694; 6.52314567565918; 45.682071685791; 6.5289454460144;
                     13.0758094787598; 13.1214952468872; 26.2561511993408; 26.3214836120605; 13.1621150970459; 26.3250827789307; 19.7444152832031; 13.179726600647; 19.8202571868896; 39.6413688659668; 337.369354248047;
                     109.106941223145; 33.0771980285645; 1244.10498046875; 217.649551391602; 29.8120880126953; 26.5318737030029; 33.2058525085449; 6.65856885910034; 59.9287757873535; 93.273811340332; 13.3258724212646;
                     20.0516204833984; 46.7887115478516; 122.266578674316; 33.4482460021973; 26.9057483673096; 20.1797275543213; 6.73190212249756; 20.2004642486572; 26.9367446899414; 121.224540710449; 20.2046890258789;
                     84.1879730224609; 10.1027889251709; 13.4706926345825; 80.849967956543; 26.9562511444092; 6.73926401138306; 60.6552925109863; 26.9605102539063; 20.2221946716309; 27.0071907043457; 27.2747707366943;
                     102.40518951416; 6.83529758453369; 20.5245704650879; 228.691986083984; 54.8833961486816; 449.723114013672; 127.375061035156; 27.5735950469971; 27.8355884552002; 14.0143718719482; 21.0717296600342;
                     14.0962266921997; 7.0559606552124; 14.1599025726318; 21.2658100128174; 85.4459686279297; 7.12089061737061; 114.187118530273; 14.2737140655518; 42.8681526184082; 42.9628829956055; 7.19228315353394;
                     21.5876426696777; 7.19978666305542; 7.28992652893066; 21.9261646270752; 51.6028022766113; 22.1385650634766; 22.1616096496582; 74.0216369628906; 3962.228515625; 7.42523097991943; 734.851989746094;
                     7.44028568267822; 37.3154067993164; 29.8824577331543; 14.9415254592896; 37.372371673584; 11.2119493484497; 18.695671081543; 33.7210273742676; 67.5088119506836; 22.5499477386475; 15.0399503707886;
                     7.52375030517578; 11.2866554260254; 30.0987415313721; 45.1929931640625; 15.1383743286133; 37.8467063903809; 30.3076171875; 22.7540397644043; 15.1827344894409; 68.3914337158203; 7.59940338134766;
                     110.296203613281; 34.3638076782227; 22.9980430603027; 15.3607892990112; 7.69210004806519; 824.891845703125; 7.71806716918945; 30.9309253692627; 34.7991561889648; 23.481575012207; 102.0458984375;
                     39.2661476135254; 23.6138725280762; 31.5139007568359; 31.5424003601074; 7.91418313980103; 23.7642784118652; 39.6400337219238; 31.8284435272217; 139.253326416016; 59.7333831787109; 39.8586387634277;
                     36.2232246398926; 32.5886650085449; 32.590747833252; 40.8443069458008; 8.22427558898926; 730.621704101563; 24.6939182281494; 263.068054199219; 33.0083084106445; 16.5728950500488; 16.6136569976807;
                     37.5044174194336; 37.5081825256348; 16.6806945800781; 33.3865737915039; 54.2562217712402; 25.0417766571045; 12973.328125; 23.4803619384766; 37.5921173095703; 3057.90600585938; 25.085485458374;
                     42.0787582397461; 8.42193031311035; 33.7156982421875; 385.171508789063; 25.5294628143311; 34.4097366333008; 17.2304344177246; 77.5423889160156; 120.713745117188; 51.7356147766113; 352.709686279297;
                     43.1772193908691; 25.9070415496826; 83.8321762084961; 39.7109146118164; 26.6274738311768; 17.8018569946289; 26.915433883667; 17.9664649963379; 267.633483886719; 31.8195514678955; 18.1828212738037;
                     18.2562961578369; 9.12875175476074; 36.5854988098145; 18.2947845458984; 9.24024295806885; 49.5841827392578|])
                let mz,intensity = unzipIMzliteArray peak1D.Peaks
                Expect.isTrue (
                    (referenceMz |> Array.map (fun mz -> Math.Round(mz,7))) = (mz |> Array.map (fun (mz:float) -> Math.Round(mz,7)))
                ) "Error in ReadSpectrumPeaks MZ Array"
                Expect.isTrue (
                    (referenceIntensity |> Array.map (fun itz -> Math.Round(itz,5))) = (intensity |> Array.map (fun itz -> Math.Round(itz,5)))
                ) "Error in ReadSpectrumPeaks Intensity Array"
                Expect.isTrue(
                    peak1D.CompressionType = BinaryDataCompressionType.ZLib &&
                    peak1D.IntensityDataType = BinaryDataType.Float64 &&
                    peak1D.MzDataType = BinaryDataType.Float64
                ) "Error in ReadSpectrumPeaks"
        ]
    ]